{"version":3,"file":"composition.js","names":["Embed","Emitter","Composition","isComposing","constructor","scroll","emitter","quill","setupListeners","domNode","addEventListener","event","root","classList","remove","handleCompositionStart","queueMicrotask","handleCompositionEnd","on","events","SELECTION_CHANGE","_range","_oldRange","_source","hasFocus","CompositionEvent","dispatchEvent","Event","bubbles","blot","target","Node","find","emit","COMPOSITION_BEFORE_START","batchStart","COMPOSITION_START","COMPOSITION_BEFORE_END","batchEnd","COMPOSITION_END","composing"],"sources":["../../src/core/composition.ts"],"sourcesContent":["import Embed from '../blots/embed.js';\nimport type Scroll from '../blots/scroll.js';\nimport Emitter from './emitter.js';\nimport type Quill from '../core/quill.js';\n\nclass Composition {\n  isComposing = false;\n  private quill: Quill;\n\n  constructor(\n    private scroll: Scroll,\n    private emitter: Emitter,\n    quill: Quill\n  ) {\n    this.quill = quill;\n    this.setupListeners();\n  }\n\n  private setupListeners() {\n    this.scroll.domNode.addEventListener('compositionstart', (event) => {\n      this.quill.root.classList.remove('ql-blank');\n\n      if (!this.isComposing) {\n        this.handleCompositionStart(event);\n      }\n    });\n\n    this.scroll.domNode.addEventListener('compositionend', (event) => {\n      if (this.isComposing) {\n        // Webkit makes DOM changes after compositionend, so we use microtask to\n        // ensure the order.\n        // https://bugs.webkit.org/show_bug.cgi?id=31902\n        queueMicrotask(() => {\n          this.handleCompositionEnd(event);\n        });\n      }\n    });\n\n    this.emitter.on(Emitter.events.SELECTION_CHANGE, (_range, _oldRange, _source) => {\n      if (this.isComposing && !this.quill.hasFocus()) {\n        this.handleCompositionEnd(new CompositionEvent('compositionend'));\n      }\n    });\n  }\n\n  private handleCompositionStart(event: CompositionEvent) {\n    this.quill.root.dispatchEvent(new Event('composition-start', { bubbles: true }));\n\n    const blot = event.target instanceof Node\n      ? this.scroll.find(event.target, true)\n      : null;\n\n    if (blot && !(blot instanceof Embed)) {\n      this.emitter.emit(Emitter.events.COMPOSITION_BEFORE_START, event);\n      this.scroll.batchStart();\n      this.emitter.emit(Emitter.events.COMPOSITION_START, event);\n      this.isComposing = true;\n    }\n  }\n\n  private handleCompositionEnd(event: CompositionEvent) {\n    this.quill.root.dispatchEvent(new Event('composition-end', { bubbles: true }));\n\n    this.emitter.emit(Emitter.events.COMPOSITION_BEFORE_END, event);\n    this.scroll.batchEnd();\n    this.emitter.emit(Emitter.events.COMPOSITION_END, event);\n    this.isComposing = false;\n  }\n\n  get composing(): boolean {\n    return this.isComposing;\n  }\n}\n\nexport default Composition;\n"],"mappings":"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","ignoreList":[]}